<!DOCTYPE html>
<html>

<head prefix="og:http://ogp.me/ns#">
    <title>Moonlander</title>
    <meta name="description" content="キーボードの上下左右で移動してフラッグ目指して着陸します。">
    <meta charset="utf-8">
    <meta property="og:url" content="https://paxcreation.com/abe/moon/moon.html" />
    <meta property="og:type" content="product" />
    <meta property="og:title" content="Moonlander" />
    <meta property="og:description" content="キーボードの上下左右で移動してフラッグ目指して着陸します。" />
    <meta property="og:site_name" content="Moonlander" />
    <meta property="og:image" content="https://paxcreation.com/abe/moon/assets/ogp.jpg" />
    <meta name="robots" content="noindex,nofollow">
    <style>
        body {
            margin: 0;
            background-color: black;
        }
    </style>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
</head>

<body>
    <canvas id="game-canvas"></canvas>
    <script>
        const config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 900,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 80 }, // 重力を強く設定
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);

        let gameStarted = false;

        function showTitle(scene) {
    const title = scene.add.image(scene.game.config.width / 2, scene.game.config.height / 2, 'title');
    title.setDisplaySize(800, 500);
    title.setInteractive();

    title.once('pointerup', () => {
        gameStarted = true;
        scene.tweens.add({
            targets: title,
            alpha: 0,
            duration: 500,
            onComplete: () => {
                title.destroy();
            }
        });
        scene.startSound.play(); // ゲームが開始されたら音声を再生
    });
}

        function restartGame(scene) {
            gameStarted = false;
            scene.spaceship.setVisible(true); // 再スタート時に宇宙船をリセット
            scene.spaceship.setPosition(scene.game.config.width / 2, 150); // 宇宙船の位置をリセット
            scene.spaceship.setVelocity(0); // 宇宙船の速度をリセット
            scene.spaceship.setAcceleration(0); // 宇宙船の加速度をリセット
            scene.spaceship.setGravityY(80); // 宇宙船の重力をリセット
            scene.scene.restart();
            scene.startSound.stop(); // ゲームが再開されたら音声を再生
        }


        function preload() {
            this.load.image('background', 'assets/background.png');
            this.load.image('spaceship', 'assets/spaceship.png');
            this.load.image('flag', 'assets/flag.png');
            this.load.spritesheet('explosion', 'assets/explosion.png', { frameWidth: 256, frameHeight: 256 });
            this.load.image('title', 'assets/title.png');
            this.load.audio('start', 'assets/start.wav');
            this.load.audio('goal', 'assets/goal.wav');
            
        }

        function create() {
            this.add.image(0, 0, 'background').setOrigin(0, 0);

            // 着陸エリアのスプライトを作成
            this.moon = this.add.sprite(Phaser.Math.Between(200, this.game.config.width - 200), this.game.config.height - 100, 'flag');
            this.physics.add.existing(this.moon, true); // 静的な物体に設定
            this.moon.body.allowGravity = false;
            this.moon.displayWidth = 30; // 以前の値の半分に変更
            this.moon.displayHeight = 50; // 以前の値の半分に変更
            this.moon.body.setSize(30, 5, false).setOffset(0, this.moon.displayHeight - 5);

            this.spaceship = this.physics.add.sprite(this.game.config.width / 2, 150, 'spaceship'); // Y座標を修正
            this.spaceship.setCollideWorldBounds(true); // 画面外に出ないように設定
            this.spaceship.setDrag(0); // 慣性の設定
            this.spaceship.setAngularDrag(8); // 慣性の設定
            this.spaceship.setMaxVelocity(100000); // 最大速度の設定
            this.spaceship.setGravityY(80);
            this.spaceship.displayWidth = 50; // 以前の値の半分に変更
            this.spaceship.displayHeight = 50; // 以前の値の半分に変更
            this.cursors = this.input.keyboard.createCursorKeys();

            this.startSound = this.sound.add('start', { loop: true });

            this.goalSound = this.sound.add('goal', { loop: false });
            this.goalTimer = 0;


            // 爆発アニメーションの作成
            this.anims.create({
                key: 'explode',
                frames: this.anims.generateFrameNumbers('explosion', { start: 0, end: 64 }),
                frameRate: 32,
                repeat: 0,
                onUpdate: function (anim, frame, gameObject) {
                    if (frame.prevFrame !== null) {
                        gameObject.setTexture(frame.texture.key, frame.prevFrame.textureSourceIndex);
                    }
                },
                onComplete: function (anim, frame, gameObject) {
                    gameObject.destroy();
                }
            });

            showTitle(this);

        }

        function update() {
            if (!gameStarted) {
                this.spaceship.setVelocity(0);
                this.spaceship.setAcceleration(0);
                return;
            }


            if (this.cursors.up.isDown) {
                this.spaceship.setAccelerationY(-500);
            } else if (this.cursors.down.isDown) {
                this.spaceship.setAccelerationY(500);
            } else {
                this.spaceship.setAccelerationY(0);
            }
            if (this.cursors.left.isDown) {
                this.spaceship.setAccelerationX(-500);
            } else if (this.cursors.right.isDown) {
                this.spaceship.setAccelerationX(500);
            } else {
                this.spaceship.setAccelerationX(0);
            }

            // 着陸エリアに接触した時にクリア
            const landingZone = new Phaser.Geom.Rectangle(
                this.moon.x - this.moon.displayWidth / 2,
                this.moon.y + this.moon.displayHeight / 2 - 5,
                this.moon.displayWidth,
                5
            );

            if (Phaser.Geom.Intersects.RectangleToRectangle(this.spaceship.getBounds(), landingZone)) {
                this.goalTimer += this.game.loop.delta; // タイマーを増加させる

                if (this.goalTimer >= 1000) { // タイマーが1000ミリ秒（1秒）以上になったら
                    this.goalTimer = 0; // タイマーをリセットする
                    this.scene.pause(); // 一時停止
                    this.goalSound.play(); // ゴール時に音を再生
                    this.add.text(400, 300, 'Mission Complete!', { fontSize: '32px', fill: '#FFF' });

                    setTimeout(() => {
                        this.spaceship.setVelocityX(0); // X軸方向の速度を0にする
                        this.spaceship.setVelocityY(0); // Y軸方向の速度を0にする
                        this.spaceship.setAccelerationX(0); // X軸方向の加速度を0にする
                        this.spaceship.setAccelerationY(0); // Y軸方向の加速度を0にする
                        this.spaceship.setGravityY(0); // Y軸方向の重力を0にする

                        setTimeout(() => {
                            restartGame(this);
                        }, 5000);
                    }, 5000); // 5000ミリ秒（5秒）後に実行
                }
            } else {
                this.goalTimer = 0; // 触れていない場合、タイマーをリセットする
            }

            // 宇宙船が画面下に達したかどうかを確認
            if (this.spaceship.y + this.spaceship.displayHeight / 2 >= this.game.config.height - 30) {
                gameOver(this, 'Mission Failed');
            }
        }

        let explosionPlaying = false;

        function gameOver(scene, message) {
            if (!explosionPlaying) {
                explosionPlaying = true;
                scene.startSound.stop(); // 爆発時に音声を停止

                // 爆発アニメーションを作成して再生
                const explosion = scene.add.sprite(scene.spaceship.x, scene.spaceship.y, 'explosion');
                explosion.play('explode');

                // 宇宙船を非表示にする
                scene.spaceship.setVisible(false);

                explosion.on('animationcomplete', () => {
                    explosionPlaying = false;
                    explosion.destroy();
                });

                // ゲームオーバーメッセージを2秒遅らせて表示する
                setTimeout(() => {
                    scene.add.text(400, 300, message, { fontSize: '32px', fill: '#FFF' });
                }, 2000); // 2000ミリ秒（2秒）後に実行

                // ゲームのアップデートを爆発アニメーションが終了してから停止する
                setTimeout(() => {
                    scene.scene.pause();
                }, 2000); // 3000ミリ秒（3秒）後に実行

                setTimeout(() => {
                    restartGame(scene);
                }, 3000);
            }
        }

    </script>

</body>

</html>